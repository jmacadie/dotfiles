#!/usr/bin/env bash
set -euo pipefail

branch="${1-}"
if [[ -z "$branch" ]]; then
  echo "Usage: git co <branch> [<upstream-tracking-branch>]"
  exit 1
fi

# Determine upstream tracking target for merges (`@{u}`)
if [[ $# -eq 1 ]]; then
  remote="origin/development"
else
  remote_input="${2-}"
  if [[ "$remote_input" == origin/* ]]; then
    remote="$remote_input"
  else
    remote="origin/$remote_input"
  fi
fi

# Switch or create local branch
if git show-ref --verify --quiet "refs/heads/$branch"; then
  echo "Local branch already exists, switching to it"
  git switch "$branch" > /dev/null
elif git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
  echo "Creating local branch from remote"
  git switch -c "$branch" --track "origin/$branch" > /dev/null
else
  echo "Creating new local branch"
  git switch -c "$branch" > /dev/null
fi

# Set upstream for merges and push target
git branch --set-upstream-to="$remote" "$branch" > /dev/null
git config "branch.$branch.pushRemote" origin > /dev/null

upstream=$(git rev-parse --symbolic-full-name @{u})
echo "  -> Upstream tracking: '$upstream'"

if git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
  push=$(git rev-parse --symbolic-full-name @{push})
  echo "  -> Push to: '$push'"
else
  echo "  -> Push branch not yet on remote. It will be called 'origin/$branch'"
fi

